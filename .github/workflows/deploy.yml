name: Deploy Java application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: google-github-actions/setup-gcloud@v0
        with:
          version: latest
      - run: gcloud auth configure-docker --quiet
      - run: docker build -t gcr.io/$us-central1-docker.pkg.dev/midyear-byway-418606/wif-demo:${{ github.sha }} .
      - run: docker push gcr.io/$us-central1-docker.pkg.dev/midyear-byway-418606/wif-demo:${{ github.sha }}
      - run: gcloud compute instances create instance-wif-demo \
          --image-project=ubuntu-2004-focal-v20240426 \
          --machine-type=e2-micro-standard-4 \
          --scopes cloud-platform \
          --metadata-from-file startup-script=startup-script.sh \
          --metadata google-docker-registry=gcr.io \
          --metadata google-docker-image=$us-central1-docker.pkg.dev/midyear-byway-418606/wif-demo:${{ github.sha }}
